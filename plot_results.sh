#!/bin/bash
# SPDX-License-Identifier: GPL-2.0-or-later

# Plot the results from run_performance_test.sh
# Assumes files have same names and folder layout as generated by run_performance_test.sh

source experiments.conf

OMIT=${OMIT:-0}

base_folder=$1
filter_src_ip=$2

ip_arg=""
if [[ -n "$filter_src_ip" ]]; then
    ip_arg="-s $filter_src_ip"
fi

echo "Plotting comparsion graphs..."
./pping_compare_viz.py -i $base_folder -o ${base_folder}/pping_comparison.png -I $IFACE -O $OMIT $ip_arg

if [[ -f "${base_folder}/e_pping/M2/pping.err.xz" ]]; then
    echo "Plotting eBPF pping map cleaning and lost events..."
    ./pping_err_viz.py -i ${base_folder}/e_pping/M2/pping.err* -o ${base_folder}/epping_mapcleaning.png -T "Map cleaning and lost events"
fi


for pping in no_pping k_pping e_pping; do
    echo -e "\nPlotting results for ${base_folder}/${pping}..."

    if [[ -f "${base_folder}/${pping}/M2/M2_stats.sar.xz" ]]; then
        echo "Plotting CPU load and network interfaces"
        for M in "M1" "M2" "M3"; do
            ./sar_cpu_viz.py -i ${base_folder}/${pping}/${M}/${M}_stats.sar* -o ${base_folder}/${M}_cpu_${pping}.png -T "${M} cpu load $pping"
            ./sar_net_viz.py -i ${base_folder}/${pping}/${M}/${M}_stats.sar* -o ${base_folder}/${M}_network_${pping}.png -T "${M} network for $pping"
        done

    else
        echo "Warning: No sar data found!"
    fi

    if [[ -f "${base_folder}/${pping}/M1/ss_tcp.log.xz" ]]; then
        echo "Plotting TCP info..."
        ./ss_tcp_viz.py -i ${base_folder}/${pping}/M1/ss_tcp.log* -o ${base_folder}/TCP_stats_${pping}.png -g
    else
        echo "Warning: No TCP data found!"
    fi
done
